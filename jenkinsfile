pipeline {
    agent any
    
     environment { 
        registry = "shashimls276/vaccination" 
        registryCredential = 'dockerhub_id' 
        dockerImage = '' 
    }
    
    tools {
        jdk 'JAVA_HOME'
    }

    stages {
        
        stage ('Initialize') {
            steps {
                sh '''
                    echo "PATH = '/usr/lib/jvm/java-8-openjdk-amd64'"
                    echo "JAVA_HOME = /usr/lib/jvm/java-8-openjdk-amd64"
                    
                '''
            }
        }
        
        stage('Build') {
            steps {
                // Get some code from a GitHub repository
                git 'https://github.com/shashimls276/Vaccination.git'

                // Run Maven on a Unix agent.
                sh "mvn clean install"
            }

        }
        
        stage('Docker image Build'){
            steps {
                script{
                    //sh "docker image build -t demo ."
                    dockerImage = docker.build registry + ":$BUILD_NUMBER"
                }
            }
        }
        
        stage('Deploy our image') { 

            steps { 
                script { 
                    docker.withRegistry( '', registryCredential ) { 
                        dockerImage.push() 
                    }
                } 
            }
        }
        
        stage('Run Image'){
            steps {
                sh 'docker run -dp 8081:8081 $registry:$BUILD_NUMBER'
            }
        }
        
    }
}
